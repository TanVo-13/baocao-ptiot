<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống nhà thông minh</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" type="text/javascript"></script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>HỆ THỐNG NHÀ THÔNG MINH</h1>
            <div class="auth-buttons">
                <button id="login-btn" class="auth-btn">Đăng nhập</button>
                <button id="signup-btn" class="auth-btn">Đăng ký</button>
                <div id="user-info" style="display: none;">
                    <span id="user-icon">👤</span> <!-- Biểu tượng người dùng -->
                    <span id="user-name"></span> <!-- Tên người dùng -->
                    <button id="logout-btn" class="auth-btn">Đăng xuất</button>
                </div>
            </div>
        </header>

        <!-- Modal Đăng nhập -->
        <div id="login-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Đăng nhập</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Mật khẩu" required>
                    <button type="submit">Đăng nhập</button>
                </form>
            </div>
        </div>

        <!-- Modal Đăng ký -->
        <div id="signup-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Đăng ký</h2>
                <form id="signup-form">
                    <input type="text" id="signup-name" placeholder="Tên đăng nhập" required>
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Mật khẩu" required>
                    <div class="verification-section">
                        <input type="text" id="verification-code" placeholder="Mã xác nhận">
                        <button type="button" id="send-code-btn">Gửi mã</button>
                    </div>
                    <button type="submit">Đăng ký</button>
                </form>
            </div>
        </div>

        <!-- Dữ liệu cảm biến -->
        <div class="sensor-grid">
            <!-- Độ ẩm -->
            <div class="sensor-card humidity">
                <div class="icon">💧</div>
                <div class="data">
                    <p>Độ ẩm</p>
                    <span id="humidity">55</span>
                </div>
            </div>

            <div class="sensor-card humidity">
                <div class="icon">💧</div>
                <div class="data">
                    <p>Độ ẩm đất</p>
                    <span id="humidity-soil">100</span>
                </div>
            </div>

            <!-- Khí gas -->
            <div class="sensor-card gas">
                <div class="icon">💨</div>
                <div class="data">
                    <p>Khí gas</p>
                    <span id="gas">61</span>
                </div>
            </div>

            <!-- Nhiệt độ -->
            <div class="sensor-card temperature">
                <div class="icon">🌞</div>
                <div class="data">
                    <p>Nhiệt độ</p>
                <span id="temperature">1711</span>
                </div>
            </div>

            <!-- Cảm biến mưa -->
            <div class="sensor-card motion">
                <div class="icon">🌧️</div>
                <div class="data">
                    <p>Cảm biến mưa</p>
                    <span id="motion">X</span>
                </div>
            </div>

            <!-- Khoảng cách tới mực nước -->
            <div class="sensor-card co2">
                <div class="icon">📏</div>
                <div class="data">
                    <p>Khoảng cách tới mực nước</p>
                    <span id="co2">225</span>
                </div>
            </div>

            <!-- Mái che -->
            <div class="sensor-card door">
                <div class="icon">⛱️</div>
                <div class="data">
                    <p>Mái che</p>
                    <span id="door">Đang bật</span>
                </div>
            </div>
        </div>

        <!-- Nút điều khiển -->
        <div class="control-buttons">
            <button id="motor-on" class="btn on">Bật motor</button>
            <button id="motor-off" class="btn off">Tắt motor</button>
            <button id="light-on" class="btn on">Bật đèn</button>
            <button id="light-off" class="btn off">Tắt đèn</button>
        </div>
    </div>
    <script>
        //$('.bat').click(function(){
            //message = new Paho.MQTT.Message("on");
            //message.destinationName = "VLUTE/LED";
            //client.send(message);
        //});
    
        //$('.tat').click(function(){
            //message = new Paho.MQTT.Message("off");
            //message.destinationName = "VLUTE/LED";
            //client.send(message);
        //});
    
        client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "b5df0685-8a6f-4639-9211-e3336dae0b52");
    
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
    
        client.connect({onSuccess:onConnect});
    
        function onConnect() {
        console.log("onConnect");
           client.subscribe("HeThongNhaThongMinh");
        }
    
        function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("onConnectionLost:"+responseObject.errorMessage);
        }
        }
    
        function onMessageArrived(message) {
        console.log("onMessageArrived:"+message.payloadString);
        }

        // Hiển thị/ẩn modal
        const loginModal = document.getElementById("login-modal");
        const signupModal = document.getElementById("signup-modal");

        document.getElementById("login-btn").onclick = () => loginModal.style.display = "block";
        document.getElementById("signup-btn").onclick = () => signupModal.style.display = "block";

        document.querySelectorAll(".close").forEach(btn => {
            btn.onclick = () => {
                loginModal.style.display = "none";
                signupModal.style.display = "none";
            }
        });

        window.onclick = (event) => {
            if (event.target == loginModal) loginModal.style.display = "none";
            if (event.target == signupModal) signupModal.style.display = "none";
        };
        
        // Đăng ký
        document.getElementById("signup-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const name = document.getElementById("signup-name").value;
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;
    const inputCode = document.getElementById("verification-code").value;

    // Kiểm tra mã xác nhận
    if (!generatedCode || inputCode != generatedCode) {
        alert("Mã xác nhận không đúng hoặc chưa được gửi.");
        return;
    }

    // Kiểm tra xem email đã tồn tại chưa
    firebase.auth().fetchSignInMethodsForEmail(email)
        .then((methods) => {
            if (methods.length > 0) {
                alert("Email đã tồn tại. Vui lòng đăng nhập hoặc dùng email khác.");
                throw new Error("Email đã tồn tại");
            } else {
                // Email chưa tồn tại → tạo tài khoản
                return firebase.auth().createUserWithEmailAndPassword(email, password);
            }
        })
        .then((userCredential) => {
            if (userCredential) {
                return userCredential.user.updateProfile({
                    displayName: name
                });
            }
        })
        .then(() => {
            alert("Đăng ký thành công!");
            signupModal.style.display = "none";
        })
        .catch((error) => {
            if (error.message !== "Email đã tồn tại") {
                alert("Lỗi: " + error.message);
            }
        });
});



        // Đăng nhập
        document.getElementById("login-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    alert("Đăng nhập thành công!");
                    const user = userCredential.user;
                    loginModal.style.display = "none";

                    document.getElementById("user-name").textContent = user.displayName; // Hiển thị tên
                    document.getElementById("user-info").style.display = "inline-block"; // Hiển thị thông tin người dùng

                    document.getElementById("logout-btn").style.display = "inline-block";
                    document.getElementById("login-btn").style.display = "none";
                    document.getElementById("signup-btn").style.display = "none";
                })
                .catch((error) => {
                    alert("Lỗi: " + error.message);
                });
        });

        // Đăng xuất
        document.getElementById("logout-btn").addEventListener("click", function () {
            firebase.auth().signOut().then(() => {
                alert("Đã đăng xuất!");
                document.getElementById("logout-btn").style.display = "none";
                document.getElementById("login-btn").style.display = "inline-block";
                document.getElementById("signup-btn").style.display = "inline-block";
            });
        });

    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAvVAvABJNxy8GxZbg_bzRNCvlAIvWGON0",
          authDomain: "hethongnhathongminh.firebaseapp.com",
          databaseURL: "https://hethongnhathongminh-default-rtdb.firebaseio.com",
          projectId: "hethongnhathongminh",
          storageBucket: "hethongnhathongminh.firebasestorage.app",
          messagingSenderId: "492237635095",
          appId: "1:492237635095:web:9482fd0660c72fb670e652"
        };
      
        firebase.initializeApp(firebaseConfig);
      </script>
      <script>
        let generatedCode = null;
    
        document.getElementById("send-code-btn").addEventListener("click", function () {
            const email = document.getElementById("signup-email").value;
            if (!email) {
                alert("Vui lòng nhập email trước khi gửi mã.");
                return;
            }
    
            generatedCode = Math.floor(100000 + Math.random() * 900000); // Mã 6 chữ số
    
            // Gửi mã qua Firebase hoặc email server của bạn
            fetch('http://localhost:3000/send-verification-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: generatedCode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("Đã gửi mã xác nhận đến email!");
                } else {
                    alert("Không thể gửi mã. Vui lòng thử lại.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Lỗi khi gửi mã xác nhận.");
            });
        });

// Kiểm tra trạng thái đăng nhập khi tải lại trang
firebase.auth().onAuthStateChanged(function (user) {
    if (user) {
        document.getElementById("user-name").textContent = user.displayName;
        document.getElementById("user-info").style.display = "inline-block";
        document.getElementById("logout-btn").style.display = "inline-block";
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("signup-btn").style.display = "none";
    } else {
        document.getElementById("user-info").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
        document.getElementById("login-btn").style.display = "inline-block";
        document.getElementById("signup-btn").style.display = "inline-block";
    }
});


    </script>
</body>
</html>