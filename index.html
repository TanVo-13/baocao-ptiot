<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Há»‡ thá»‘ng nhÃ  thÃ´ng minh</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"
      type="text/javascript"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.6.1.min.js"
      type="text/javascript"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <header>
        <h1>Há»† THá»NG NHÃ€ THÃ”NG MINH</h1>
        <div class="auth-buttons">
          <button id="login-btn" class="auth-btn">ÄÄƒng nháº­p</button>
          <button id="signup-btn" class="auth-btn">ÄÄƒng kÃ½</button>
          <div id="user-info" style="display: none">
            <!-- Biá»ƒu tÆ°á»£ng ngÆ°á»i dÃ¹ng -->
            <span id="user-name"></span>
            <!-- TÃªn ngÆ°á»i dÃ¹ng -->
            <button id="logout-btn" class="auth-btn">ÄÄƒng xuáº¥t</button>
          </div>
        </div>
      </header>

      <!-- Modal ÄÄƒng nháº­p -->
      <div id="login-modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>ÄÄƒng nháº­p</h2>
          <form id="login-form">
            <input type="email" id="login-email" placeholder="Email" required />
            <input
              type="password"
              id="login-password"
              placeholder="Máº­t kháº©u"
              required
            />
            <button type="submit">ÄÄƒng nháº­p</button>
          </form>
        </div>
      </div>

      <!-- Modal ÄÄƒng kÃ½ -->
      <div id="signup-modal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h2>ÄÄƒng kÃ½</h2>
          <form id="signup-form">
            <input
              type="text"
              id="signup-name"
              placeholder="TÃªn Ä‘Äƒng nháº­p"
              required
            />
            <input
              type="email"
              id="signup-email"
              placeholder="Email"
              required
            />
            <input
              type="password"
              id="signup-password"
              placeholder="Máº­t kháº©u"
              required
            />
            <div class="verification-section">
              <input
                type="text"
                id="verification-code"
                placeholder="MÃ£ xÃ¡c nháº­n"
              />
              <button type="button" id="send-code-btn">Gá»­i mÃ£</button>
            </div>
            <button type="submit">ÄÄƒng kÃ½</button>
          </form>
        </div>
      </div>

      <!-- Dá»¯ liá»‡u cáº£m biáº¿n -->
      <div
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"
      >
        <!-- Cáº£m biáº¿n DHT22 -->
        <a
          href="./dht22.html"
          class="bg-green-50 shadow rounded-2xl p-5 flex flex-col gap-3 transition-all duration-300 hover:-translate-y-2"
        >
          <div class="text-sm font-semibold text-gray-700">
            ğŸŒ¡ï¸ Cáº£m biáº¿n DHT22 (Nhiá»‡t Ä‘á»™ & Äá»™ áº©m khÃ´ng khÃ­)
          </div>
          <div class="flex flex-col gap-1 text-gray-800">
            <div class="flex items-center justify-between">
              <span>ğŸ’§ Äá»™ áº©m:</span>
              <span id="humidity" class="font-bold text-green-700"
                >ChÆ°a xÃ¡c Ä‘á»‹nh</span
              >
            </div>
            <div class="flex items-center justify-between">
              <span>ğŸŒ Nhiá»‡t Ä‘á»™:</span>
              <span id="temperature" class="font-bold text-green-700"
                >ChÆ°a xÃ¡c Ä‘á»‹nh</span
              >
            </div>
          </div>
        </a>

        <!-- Cáº£m biáº¿n Ä‘á»™ áº©m Ä‘áº¥t -->
        <a
          href="/doamdat.html"
          class="bg-blue-50 shadow rounded-2xl p-5 flex flex-col gap-3 transition-all duration-300 hover:-translate-y-2"
        >
          <div class="text-sm font-semibold text-gray-700">
            ğŸŒ± Cáº£m biáº¿n Ä‘á»™ áº©m Ä‘áº¥t
          </div>
          <div class="flex flex-col gap-2 text-gray-800">
            <div class="flex items-center justify-between">
              <span>ğŸ’§ Äá»™ áº©m Ä‘áº¥t:</span>
              <span id="humidity-soil" class="font-bold text-blue-700"
                >ChÆ°a xÃ¡c Ä‘á»‹nh</span
              >
            </div>
            <div class="flex items-center justify-between">
              <span>ğŸ“Š Tráº¡ng thÃ¡i:</span>
              <span id="soil-status" class="font-semibold text-blue-600"
                >ChÆ°a xÃ¡c Ä‘á»‹nh</span
              >
            </div>
          </div>
        </a>

        <!-- Cáº£m biáº¿n khÃ­ gas -->
        <a
          href="/gas.html"
          class="bg-pink-50 shadow rounded-2xl p-5 flex flex-col gap-3 transition-all duration-300 hover:-translate-y-2"
        >
          <div class="text-sm font-semibold text-gray-700">
            ğŸ”¥ Cáº£m biáº¿n khÃ­ gas
          </div>
          <div class="flex items-center justify-between text-gray-800">
            <span>ğŸ’¨ Tráº¡ng thÃ¡i:</span>
            <span id="gas-status" class="font-bold text-pink-700"
              >ChÆ°a xÃ¡c Ä‘á»‹nh</span
            >
          </div>
          <div class="flex items-center justify-between text-gray-800">
            <span>ğŸ”¢ Ná»“ng Ä‘á»™:</span>
            <span id="gas-value" class="font-bold text-pink-700"
              >ChÆ°a xÃ¡c Ä‘á»‹nh</span
            >
          </div>
        </a>

        <!-- Cáº£m biáº¿n mÆ°a -->
        <a
          href="/mua.html"
          class="bg-indigo-50 shadow rounded-2xl p-5 flex flex-col gap-3 transition-all duration-300 hover:-translate-y-2"
        >
          <div class="text-sm font-semibold text-gray-700">ğŸŒ§ï¸ Cáº£m biáº¿n mÆ°a</div>
          <div class="flex items-center justify-between text-gray-800">
            <span>ğŸŒ¦ï¸ TÃ¬nh tráº¡ng:</span>
            <span id="rain-status" class="font-bold text-indigo-700"
              >ChÆ°a xÃ¡c Ä‘á»‹nh</span
            >
          </div>
        </a>

        <!-- Cáº£m biáº¿n má»±c nÆ°á»›c -->
        <a
          href="./sieuam.html"
          class="bg-yellow-50 shadow rounded-2xl p-5 flex flex-col gap-3 transition-all duration-300 hover:-translate-y-2"
        >
          <div class="text-sm font-semibold text-gray-700">
            ğŸ“ Cáº£m biáº¿n siÃªu Ã¢m
          </div>
          <div class="flex flex-col gap-2 text-gray-800">
            <div class="flex items-center justify-between">
              <span>Khoáº£ng cÃ¡ch Ä‘áº¿n má»±c nÆ°á»›c:</span>
              <span id="water-level" class="font-bold text-yellow-700"
                >ChÆ°a xÃ¡c Ä‘á»‹nh</span
              >
            </div>
            <div class="flex items-center justify-between">
              <span>ğŸ“Š Tráº¡ng thÃ¡i:</span>
              <span id="water-status" class="font-semibold text-yellow-600"
                >ChÆ°a xÃ¡c Ä‘á»‹nh</span
              >
            </div>
          </div>
        </a>

        <!-- Cáº£m biáº¿n Ã¡nh sÃ¡ng -->
        <a
          href="./anhsang.html"
          class="bg-white shadow rounded-2xl p-5 flex flex-col gap-3 transition-all duration-300 hover:-translate-y-2"
        >
          <div class="text-sm font-semibold text-gray-700">
            ğŸ’¡ Cáº£m biáº¿n Ã¡nh sÃ¡ng
          </div>
          <div class="flex items-center justify-between text-gray-800">
            <span>â˜€ï¸ CÆ°á»ng Ä‘á»™ Ã¡nh sÃ¡ng:</span>
            <span id="light-intensity" class="font-bold text-gray-800"
              >ChÆ°a xÃ¡c Ä‘á»‹nh</span
            >
          </div>
          <div class="flex items-center justify-between text-gray-800">
            <span>ğŸ”† Má»©c Ä‘Ã¡nh giÃ¡:</span>
            <span id="light-level" class="font-semibold text-gray-700"
              >ChÆ°a xÃ¡c Ä‘á»‹nh</span
            >
          </div>
        </a>
      </div>
    </div>
    <script type="module" src="./src/js/firebase.js"></script>
    <script type="module" src="./src/js/script.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
      //$('.bat').click(function(){
      //message = new Paho.MQTT.Message("on");
      //message.destinationName = "VLUTE/LED";
      //client.send(message);
      //});

      //$('.tat').click(function(){
      //message = new Paho.MQTT.Message("off");
      //message.destinationName = "VLUTE/LED";
      //client.send(message);
      //});

      client = new Paho.MQTT.Client(
        "broker.emqx.io",
        Number(8083),
        "b5df0685-8a6f-4639-9211-e3336dae0b52"
      );

      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      client.connect({ onSuccess: onConnect });

      function onConnect() {
        console.log("onConnect");
        client.subscribe("HeThongNhaThongMinh");
      }

      function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
          console.log("onConnectionLost:" + responseObject.errorMessage);
        }
      }

      function onMessageArrived(message) {
        console.log("onMessageArrived:" + message.payloadString);
        const data = JSON.parse(message.payloadString);
        console.log(data);

        // Chuyá»ƒn Ä‘á»•i Ä‘á»™ áº©m Ä‘áº¥t sang %
        const doamdat_percent = Math.round(
          ((4095 - Number(data.doamdat)) / 4095) * 100
        );

        // Cáº­p nháº­t dá»¯ liá»‡u cáº£m biáº¿n
        document.getElementById("humidity").innerText = data.doam + "%";
        document.getElementById("temperature").innerText = data.nhietdo + "Â°C";
        document.getElementById("humidity-soil").innerText =
          doamdat_percent + "%";
        document.getElementById("soil-status").innerText =
          getStatusDoAmDat(doamdat_percent);

        document.getElementById("gas-status").innerText = getStatusKhiGas(
          Number(data.khigas)
        );
        document.getElementById("gas-value").innerText = data.khigas + " ppm";

        document.getElementById("rain-status").innerText =
          Number(data.mua) === 1 ? "Äang mÆ°a" : "Trá»i khÃ´ rÃ¡o";

        document.getElementById("water-level").innerText =
          data.khoangcach + " cm";
        document.getElementById("water-status").innerText = getStatusKhoangCach(
          Number(data.khoangcach)
        );

        document.getElementById("light-intensity").innerText =
          data.anhsang + " lx";
        document.getElementById("light-level").innerText = getStatusAnhSang(
          Number(data.anhsang)
        );
      }

      function getStatusDoAmDat(value) {
        if (value >= 80) {
          return "Äáº¥t ngáº­p nÆ°á»›c";
        } else if (value >= 50) {
          return "Äáº¥t Æ°á»›t";
        } else if (value >= 30) {
          return "Äáº¥t áº©m";
        } else {
          return "Äáº¥t khÃ´";
        }
      }

      function getStatusKhoangCach(value) {
        if (value >= 350) {
          return "Bá»ƒ gáº§n cáº¡n";
        } else if (value >= 200) {
          return "Bá»ƒ chÆ°a Ä‘áº§y";
        } else if (value >= 20) {
          return "Bá»ƒ gáº§n Ä‘áº§y";
        } else {
          return "Bá»ƒ chá»©a Ä‘áº§y";
        }
      }

      function getStatusAnhSang(value) {
        if (value <= 100) {
          return "Tá»‘i";
        } else if (value < 1000) {
          return "SÃ¡ng vá»«a";
        } else {
          return "SÃ¡ng máº¡nh";
        }
      }

      function getStatusKhiGas(value) {
        if (value >= 2000) {
          return "Nguy hiá»ƒm! Ná»“ng Ä‘á»™ khÃ­ gas ráº¥t cao";
        } else if (value >= 1234) {
          return "PhÃ¡t hiá»‡n khÃ­ gas";
        } else if (value >= 400) {
          return "CÃ³ dáº¥u hiá»‡u khÃ­ gas";
        } else {
          return "KhÃ´ng phÃ¡t hiá»‡n khÃ­ gas";
        }
      }
    </script>
  </body>
</html>
