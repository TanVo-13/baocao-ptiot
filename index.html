<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Há»‡ thá»‘ng nhÃ  thÃ´ng minh</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" type="text/javascript"></script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header>
            <h1>Há»† THá»NG NHÃ€ THÃ”NG MINH</h1>
            <div class="auth-buttons">
                <button id="login-btn" class="auth-btn">ÄÄƒng nháº­p</button>
                <button id="signup-btn" class="auth-btn">ÄÄƒng kÃ½</button>
                <div id="user-info" style="display: none;">
                    <span id="user-icon">ğŸ‘¤</span> <!-- Biá»ƒu tÆ°á»£ng ngÆ°á»i dÃ¹ng -->
                    <span id="user-name"></span> <!-- TÃªn ngÆ°á»i dÃ¹ng -->
                    <button id="logout-btn" class="auth-btn">ÄÄƒng xuáº¥t</button>
                </div>
            </div>
        </header>

        <!-- Modal ÄÄƒng nháº­p -->
        <div id="login-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>ÄÄƒng nháº­p</h2>
                <form id="login-form">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Máº­t kháº©u" required>
                    <button type="submit">ÄÄƒng nháº­p</button>
                </form>
            </div>
        </div>

        <!-- Modal ÄÄƒng kÃ½ -->
        <div id="signup-modal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>ÄÄƒng kÃ½</h2>
                <form id="signup-form">
                    <input type="text" id="signup-name" placeholder="TÃªn Ä‘Äƒng nháº­p" required>
                    <input type="email" id="signup-email" placeholder="Email" required>
                    <input type="password" id="signup-password" placeholder="Máº­t kháº©u" required>
                    <div class="verification-section">
                        <input type="text" id="verification-code" placeholder="MÃ£ xÃ¡c nháº­n">
                        <button type="button" id="send-code-btn">Gá»­i mÃ£</button>
                    </div>
                    <button type="submit">ÄÄƒng kÃ½</button>
                </form>
            </div>
        </div>

        <!-- Dá»¯ liá»‡u cáº£m biáº¿n -->
        <div class="sensor-grid">
            <!-- Äá»™ áº©m -->
            <div class="sensor-card humidity">
                <div class="icon">ğŸ’§</div>
                <div class="data">
                    <p>Äá»™ áº©m</p>
                    <span id="humidity">55</span>
                </div>
            </div>

            <div class="sensor-card humidity">
                <div class="icon">ğŸ’§</div>
                <div class="data">
                    <p>Äá»™ áº©m Ä‘áº¥t</p>
                    <span id="humidity-soil">100</span>
                </div>
            </div>

            <!-- KhÃ­ gas -->
            <div class="sensor-card gas">
                <div class="icon">ğŸ’¨</div>
                <div class="data">
                    <p>KhÃ­ gas</p>
                    <span id="gas">61</span>
                </div>
            </div>

            <!-- Nhiá»‡t Ä‘á»™ -->
            <div class="sensor-card temperature">
                <div class="icon">ğŸŒ</div>
                <div class="data">
                    <p>Nhiá»‡t Ä‘á»™</p>
                <span id="temperature">1711</span>
                </div>
            </div>

            <!-- Cáº£m biáº¿n mÆ°a -->
            <div class="sensor-card motion">
                <div class="icon">ğŸŒ§ï¸</div>
                <div class="data">
                    <p>Cáº£m biáº¿n mÆ°a</p>
                    <span id="motion">X</span>
                </div>
            </div>

            <!-- Khoáº£ng cÃ¡ch tá»›i má»±c nÆ°á»›c -->
            <div class="sensor-card co2">
                <div class="icon">ğŸ“</div>
                <div class="data">
                    <p>Khoáº£ng cÃ¡ch tá»›i má»±c nÆ°á»›c</p>
                    <span id="co2">225</span>
                </div>
            </div>

            <!-- MÃ¡i che -->
            <div class="sensor-card door">
                <div class="icon">â›±ï¸</div>
                <div class="data">
                    <p>MÃ¡i che</p>
                    <span id="door">Äang báº­t</span>
                </div>
            </div>
        </div>

        <!-- NÃºt Ä‘iá»u khiá»ƒn -->
        <div class="control-buttons">
            <button id="motor-on" class="btn on">Báº­t motor</button>
            <button id="motor-off" class="btn off">Táº¯t motor</button>
            <button id="light-on" class="btn on">Báº­t Ä‘Ã¨n</button>
            <button id="light-off" class="btn off">Táº¯t Ä‘Ã¨n</button>
        </div>
    </div>
    <script>
        //$('.bat').click(function(){
            //message = new Paho.MQTT.Message("on");
            //message.destinationName = "VLUTE/LED";
            //client.send(message);
        //});
    
        //$('.tat').click(function(){
            //message = new Paho.MQTT.Message("off");
            //message.destinationName = "VLUTE/LED";
            //client.send(message);
        //});
    
        client = new Paho.MQTT.Client("broker.emqx.io", Number(8083), "b5df0685-8a6f-4639-9211-e3336dae0b52");
    
        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;
    
        client.connect({onSuccess:onConnect});
    
        function onConnect() {
        console.log("onConnect");
           client.subscribe("HeThongNhaThongMinh");
        }
    
        function onConnectionLost(responseObject) {
        if (responseObject.errorCode !== 0) {
            console.log("onConnectionLost:"+responseObject.errorMessage);
        }
        }
    
        function onMessageArrived(message) {
        console.log("onMessageArrived:"+message.payloadString);
        }

        // Hiá»ƒn thá»‹/áº©n modal
        const loginModal = document.getElementById("login-modal");
        const signupModal = document.getElementById("signup-modal");

        document.getElementById("login-btn").onclick = () => loginModal.style.display = "block";
        document.getElementById("signup-btn").onclick = () => signupModal.style.display = "block";

        document.querySelectorAll(".close").forEach(btn => {
            btn.onclick = () => {
                loginModal.style.display = "none";
                signupModal.style.display = "none";
            }
        });

        window.onclick = (event) => {
            if (event.target == loginModal) loginModal.style.display = "none";
            if (event.target == signupModal) signupModal.style.display = "none";
        };
        
        // ÄÄƒng kÃ½
        document.getElementById("signup-form").addEventListener("submit", function (e) {
    e.preventDefault();
    const name = document.getElementById("signup-name").value;
    const email = document.getElementById("signup-email").value;
    const password = document.getElementById("signup-password").value;
    const inputCode = document.getElementById("verification-code").value;

    // Kiá»ƒm tra mÃ£ xÃ¡c nháº­n
    if (!generatedCode || inputCode != generatedCode) {
        alert("MÃ£ xÃ¡c nháº­n khÃ´ng Ä‘Ãºng hoáº·c chÆ°a Ä‘Æ°á»£c gá»­i.");
        return;
    }

    // Kiá»ƒm tra xem email Ä‘Ã£ tá»“n táº¡i chÆ°a
    firebase.auth().fetchSignInMethodsForEmail(email)
        .then((methods) => {
            if (methods.length > 0) {
                alert("Email Ä‘Ã£ tá»“n táº¡i. Vui lÃ²ng Ä‘Äƒng nháº­p hoáº·c dÃ¹ng email khÃ¡c.");
                throw new Error("Email Ä‘Ã£ tá»“n táº¡i");
            } else {
                // Email chÆ°a tá»“n táº¡i â†’ táº¡o tÃ i khoáº£n
                return firebase.auth().createUserWithEmailAndPassword(email, password);
            }
        })
        .then((userCredential) => {
            if (userCredential) {
                return userCredential.user.updateProfile({
                    displayName: name
                });
            }
        })
        .then(() => {
            alert("ÄÄƒng kÃ½ thÃ nh cÃ´ng!");
            signupModal.style.display = "none";
        })
        .catch((error) => {
            if (error.message !== "Email Ä‘Ã£ tá»“n táº¡i") {
                alert("Lá»—i: " + error.message);
            }
        });
});



        // ÄÄƒng nháº­p
        document.getElementById("login-form").addEventListener("submit", function (e) {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;

            firebase.auth().signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    alert("ÄÄƒng nháº­p thÃ nh cÃ´ng!");
                    const user = userCredential.user;
                    loginModal.style.display = "none";

                    document.getElementById("user-name").textContent = user.displayName; // Hiá»ƒn thá»‹ tÃªn
                    document.getElementById("user-info").style.display = "inline-block"; // Hiá»ƒn thá»‹ thÃ´ng tin ngÆ°á»i dÃ¹ng

                    document.getElementById("logout-btn").style.display = "inline-block";
                    document.getElementById("login-btn").style.display = "none";
                    document.getElementById("signup-btn").style.display = "none";
                })
                .catch((error) => {
                    alert("Lá»—i: " + error.message);
                });
        });

        // ÄÄƒng xuáº¥t
        document.getElementById("logout-btn").addEventListener("click", function () {
            firebase.auth().signOut().then(() => {
                alert("ÄÃ£ Ä‘Äƒng xuáº¥t!");
                document.getElementById("logout-btn").style.display = "none";
                document.getElementById("login-btn").style.display = "inline-block";
                document.getElementById("signup-btn").style.display = "inline-block";
            });
        });

    </script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAvVAvABJNxy8GxZbg_bzRNCvlAIvWGON0",
          authDomain: "hethongnhathongminh.firebaseapp.com",
          databaseURL: "https://hethongnhathongminh-default-rtdb.firebaseio.com",
          projectId: "hethongnhathongminh",
          storageBucket: "hethongnhathongminh.firebasestorage.app",
          messagingSenderId: "492237635095",
          appId: "1:492237635095:web:9482fd0660c72fb670e652"
        };
      
        firebase.initializeApp(firebaseConfig);
      </script>
      <script>
        let generatedCode = null;
    
        document.getElementById("send-code-btn").addEventListener("click", function () {
            const email = document.getElementById("signup-email").value;
            if (!email) {
                alert("Vui lÃ²ng nháº­p email trÆ°á»›c khi gá»­i mÃ£.");
                return;
            }
    
            generatedCode = Math.floor(100000 + Math.random() * 900000); // MÃ£ 6 chá»¯ sá»‘
    
            // Gá»­i mÃ£ qua Firebase hoáº·c email server cá»§a báº¡n
            fetch('http://localhost:3000/send-verification-code', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, code: generatedCode })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert("ÄÃ£ gá»­i mÃ£ xÃ¡c nháº­n Ä‘áº¿n email!");
                } else {
                    alert("KhÃ´ng thá»ƒ gá»­i mÃ£. Vui lÃ²ng thá»­ láº¡i.");
                }
            })
            .catch(err => {
                console.error(err);
                alert("Lá»—i khi gá»­i mÃ£ xÃ¡c nháº­n.");
            });
        });

// Kiá»ƒm tra tráº¡ng thÃ¡i Ä‘Äƒng nháº­p khi táº£i láº¡i trang
firebase.auth().onAuthStateChanged(function (user) {
    if (user) {
        document.getElementById("user-name").textContent = user.displayName;
        document.getElementById("user-info").style.display = "inline-block";
        document.getElementById("logout-btn").style.display = "inline-block";
        document.getElementById("login-btn").style.display = "none";
        document.getElementById("signup-btn").style.display = "none";
    } else {
        document.getElementById("user-info").style.display = "none";
        document.getElementById("logout-btn").style.display = "none";
        document.getElementById("login-btn").style.display = "inline-block";
        document.getElementById("signup-btn").style.display = "inline-block";
    }
});


    </script>
</body>
</html>